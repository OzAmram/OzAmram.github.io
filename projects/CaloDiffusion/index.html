<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>CaloDiffusion | Oz Amram</title> <meta name="author" content="Oz Amram"> <meta name="description" content="Diffusion models for LHC calorimeter simulations"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%8C%B1&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://ozamram.github.io/projects/CaloDiffusion/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Oz </span>Amram</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/CV_Oz_Amram.pdf">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">CaloDiffusion</h1> <p class="post-description">Diffusion models for LHC calorimeter simulations</p> </header> <article> <p>Simulations play a crucial role in making sense of the massive amounts of data produced by the LHC. When sifting through the extremely complex data produced by our detectors, we need a handle on what were are looking at. Being able to simulate what the collisions of known processes would like in our detector, and what the signatures of hypothetical new particles would leave is essential.</p> <p>One crucial aspects of these simulations is the detector response, We need to know what sort of signals we would see in our detector if a particle of a given type and energy were passing through. Fortunately we have a very accurate first-principles understanding of how particles interact with the materials of our detector, available in a public software package GEANT. However, these simulations can be quite computationally expensive to perform, particularly for the ‘calorimeter’ portion of the detector. In calorimeters, a single high energy particle will interact with the particles present in the material to produce a ‘shower’ of secondary particles (each of which can further produce additional showers, etc), which must be accurately simulated to get a realistic estimate of the detector signal. As we move towards higher data volumes in the High-Luminosity era of the LHC, and develop even more complex calorimeters (like the CMS HGCAL), we will no longer have the computing resources to perform these detailed calorimeter simulations. This would significantly hurt the precision of our data analysis techniques unless a solution can be found.</p> <p>Thats where generative machine learning may come to the rescue. If we can train a machine learning model that can accurately generate these calorimeter showers faster than GEANT, then it could be used GEANT’s place in the simulation workflow. People in the HEP+ML community have been working on this problem for a few years and a variety of approaches are being explored. Our approach, <strong>CaloDiffusion</strong>, is based on a type of generative machine learning model called ‘diffusion’, which has extemely popular starting in ~2022. It is the backbone behind most of the popular AI image generation technologies: DALLE, MidJourny, StableDiffusion, etc. Using CaloDiffusion, we are able to obtain showers that are nearly indistiguishable from Geant.</p> <div class="row justify-content-sm-center"> <div style="text-align: center"> <img class="img-fluid rounded z-depth-1" src="/assets/img/avg_showers.png" alt="" title="Average Calorimeter Showers" width="600"> </div> </div> <div class="caption"> A comparison of the average Calorimeter showers produced by GEANT versus CaloDiffusion on a sample dataset based on photons hitting a 5 layer detector. The energy deposits in all five layers are shown, the energy deposition in each layer has a circular symmetry. </div> <p>Diffusion works as a noising/denoising process. One starts with a normal image you can define a noising process that gradually adds noise to it across many steps (around 100 steps is typical), until the image is essentially pure noise. The machine learning model is then trained to reverse this process; by learning how to remove the noise you have added at each step. Once trained, this model can then generate new images by starting with a pure noise image and iteratively applying its denoising step. Additional ‘conditioning’ information about the target image can also be given to the model, during training to help with the denoising and to allow one to guide the type of image that is generated once trained. This is particularly important for our use case, since we don’t want to generate a random particle shower, but a shower that corresponds to the specific particle type and energy that we want to simulate.</p> <div class="row justify-content-sm-center"> <div style="text-align: center"> <img class="img-fluid rounded z-depth-1" src="/assets/img/diffusion_diagram.jpg" alt="" title="Diffusion diagram" width="800"> </div> </div> <div class="caption"> A diagram showing the basics of the diffusion process. The $q(x_{t-1}| x_t)$ function iteratively adds noise to the image. The $p_{\theta}(x_t | x_{t-1})$ function is the model that learns to invert this noising process, and can generate new images starting from pure noise. </div> <p>Calorimeter data isn’t exactly like images but they have some simularities. Energy is deposited into different sensors across several layers of material. The full shower is then similar to a 3D image, where each ‘voxel encodes the energy in a given cell. Unlike objets in images which have an x and y translation symmetry, showers typically have cylindrical symmetry when centered on the point of impact of the initial particle.</p> <p>For these reasons, in CaloDiffusion we replaced the use of regular convolutions used in standard image processesing models with 3D, cylindrical convolutions, which better encode the symmetries of our data. We also included a new method to allow these convolutions to be conditional on the shower layer and radial position, which allows more expressive freedom to the model without any additional parameters.</p> <p>Unfortunately, realistic detectors never have perfect cylindrical structure. Different layers are often made of different materials, have different sensor sizes and layouts. This makes the inherent data structure of these shows very irregular, which is difficult to deal with for machine learnin models. To handle this difficulty while retaing the geometric power of convolutions, we developed a new embedding approach called <strong>GLaM</strong> which performs a lightweight mapping from the irregular geoemtry to a regular cylindrical shape, which can then be processed with our cylindrical convolutions. This embedding is learned simulataneously with the denoising model.</p> <div class="row justify-content-sm-center"> <div style="text-align: center"> <img class="img-fluid rounded z-depth-1" src="/assets/img/glam_diagram.png" alt="" title="GLaM diagram" width="800"> </div> </div> <div class="caption"> A diagram showing the GLaM approach. A mapping from the irregular input shape to the desired regular shape is learned. The denoising process based on cylindrical convolutions is learned on the regular shape, and then outputted back to the original irregular shape. </div> <p>We applied our approach to three different datasets, representing three different detectors, that were part of the community <a href="https://calochallenge.github.io/homepage/" rel="external nofollow noopener" target="_blank">Fast Calorimeter Simulation Challenge</a>. The first dataset is based on part of the ATLAS detector and includes both photon and pion showers. Because it is based on the real ATLAS detector it has realistic irregularities between the different layers, which we handle with our GLaM approach. The total dimensionality of these showers is ~500 voxels. The second and third datasets are based on an idealized perfectly cylindrical detector, but feature much high dimensionality (6480 and 40,000 voxels respectively).</p> <p>We then compared the showers generated by CaloDiffusion and Geant across many different features and found CaloDiffusion was able to match Geant extremely well across nearly all of them.</p> <div class="row justify-content-sm-center"> <div style="text-align: center"> <img class="img-fluid rounded z-depth-1" src="/assets/img/calodiffu_energy_comparisons.png" alt="" title="Diffusion diagram" width="800"> </div> </div> <div class="caption"> Some quantitative comparisons of the showers produced by Geant and CaloDiffusion on datasets two and three of the CaloChallenge. CaloDiffusion is able to match the distribution of energy as function of the layer (left) and radial dimmension (center). The width of the shower in the radial dimmension is also well modeled (right). </div> <p>We also perfomed quantitative comparisons between the two sets of showers. One popular metric is to train a NN classifier to attempt to distinguish between the two sets of showers. If this classifier is unable to perform well (AUC $\to$ 0.5), this indicates the two samples of showers are nearly indistinguishable. We found classifier AUC’s of 0.55–0.65 on the different datasets, the best values reported to date. Our approach particularly shined on the highest dimensional dataset, in which we significantly outperformed previous approaches.</p> <p>Further comparisons between CaloDiffusion and other approaches are being perfomed as part of the CaloChallenge, but the <a href="https://indico.cern.ch/event/1253794/contributions/5588599/attachments/2749348/4784940/CaloChallenge.C.Krause.pdf" rel="external nofollow noopener" target="_blank">results so far</a> show CaloDiffusion produces the highest quality showers for all datasets (with ~40 total submissions).</p> <p>Further improvements to CaloDiffusion are in progress, and we hope to apply the model to simulate the CMS HGCAL in the near future!</p> </article> <h2>References</h2> <div class="publications"> <h2 class="bibliography">2023</h2> <ol class="bibliography"><li> <div class="row"> <div class="col-sm-2 abbr"><abbr class="badge">Phys. Rev. D</abbr></div> <div id="Amram:2023onf" class="col-sm-8"> <div class="title">Denoising diffusion models with geometry adaptation for high fidelity calorimeter simulation</div> <div class="author"> <em>Oz Amram</em>, and Kevin Pedro</div> <div class="periodical"> <em>Phys. Rev. D</em>, 2023 </div> <div class="periodical"> </div> <div class="links"> <a class="abstract btn btn-sm z-depth-0" role="button">Abs</a> <a class="bibtex btn btn-sm z-depth-0" role="button">Bib</a> <a href="https://arxiv.org/abs/2308.03876" class="btn btn-sm z-depth-0" role="button" rel="external nofollow noopener" target="_blank">HTML</a> </div> <div class="badges"> </div> <div class="abstract hidden"> <p>Simulation is crucial for all aspects of collider data analysis, but the available computing budget in the High Luminosity LHC era will be severely constrained. Generative machine learning models may act as surrogates to replace physics-based full simulation of particle detectors, and diffusion models have recently emerged as the state of the art for other generative tasks. We introduce CaloDiffusion, a denoising diffusion model trained on the public CaloChallenge datasets to generate calorimeter showers. Our algorithm employs 3D cylindrical convolutions, which take advantage of symmetries of the underlying data representation. To handle irregular detector geometries, we augment the diffusion model with a new geometry latent mapping (GLaM) layer to learn forward and reverse transformations to a regular geometry that is suitable for cylindrical convolutions. The showers generated by our approach are nearly indistinguishable from the full simulation, as measured by several different metrics.</p> </div> <div class="bibtex hidden"> <figure class="highlight"><pre><code class="language-bibtex" data-lang="bibtex"><span class="nc">@article</span><span class="p">{</span><span class="nl">Amram:2023onf</span><span class="p">,</span>
  <span class="na">author</span> <span class="p">=</span> <span class="s">{Amram, Oz and Pedro, Kevin}</span><span class="p">,</span>
  <span class="na">title</span> <span class="p">=</span> <span class="s">{{Denoising diffusion models with geometry adaptation for high fidelity calorimeter simulation}}</span><span class="p">,</span>
  <span class="na">eprint</span> <span class="p">=</span> <span class="s">{2308.03876}</span><span class="p">,</span>
  <span class="na">archiveprefix</span> <span class="p">=</span> <span class="s">{arXiv}</span><span class="p">,</span>
  <span class="na">eid</span> <span class="p">=</span> <span class="s">{arxiv:2308.03876}</span><span class="p">,</span>
  <span class="na">primaryclass</span> <span class="p">=</span> <span class="s">{physics.ins-det}</span><span class="p">,</span>
  <span class="na">reportnumber</span> <span class="p">=</span> <span class="s">{FERMILAB-PUB-23-384-CSAID-PPD}</span><span class="p">,</span>
  <span class="na">doi</span> <span class="p">=</span> <span class="s">{10.1103/PhysRevD.108.072014}</span><span class="p">,</span>
  <span class="na">journal</span> <span class="p">=</span> <span class="s">{Phys. Rev. D}</span><span class="p">,</span>
  <span class="na">volume</span> <span class="p">=</span> <span class="s">{108}</span><span class="p">,</span>
  <span class="na">number</span> <span class="p">=</span> <span class="s">{7}</span><span class="p">,</span>
  <span class="na">pages</span> <span class="p">=</span> <span class="s">{072014}</span><span class="p">,</span>
  <span class="na">year</span> <span class="p">=</span> <span class="s">{2023}</span><span class="p">,</span>
<span class="p">}</span></code></pre></figure> </div> </div> </div> </li></ol> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Oz Amram. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: April 04, 2024. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?c9d9dd48933de3831b3ee5ec9c209cac" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>